/*!
 * @package jquery.ghostrelated
 * @version 0.2.0
 * @Copyright (C) 2014 Dane Grant (danecando@gmail.com)
 * Edited by Luciano Mammino
 * @License MIT
 */
!function(t){function e(e,s){this.element=e,this.options=t.extend({},defaults,s),this.parseRss()}defaults={feed:"/rss",titleClass:".post-title",tagsClass:".post-meta",limit:5,debug:!1},e.prototype.displayRelated=function(e){var s=this,r=0
this._currentPostTags=this.getCurrentPostTags(this.options.tagsClass)
var n=this.matchByTag(this._currentPostTags,e)
n.forEach(function(e){r<s.options.limit&&t(s.element).find(".related-posts-list").append(t('<li><a href="'+e.url+'">'+e.title+"</a></li>")),r++}),r>0&&t(this.element).css("display","block")},e.prototype.parseRss=function(e,s,r){var n=e||1,s=s||"",r=r||[],i=this
t.ajax({url:this.options.feed+"/"+n,type:"GET"}).done(function(e){var o=t(e).find("item > guid").text()
if(o!=s)r.push(e),i.parseRss(n+1,o,r)
else{var a=i.getPosts(r)
i.displayRelated(a)}}).fail(function(t){i.reportError(t)})},e.prototype.getCurrentPostTitle=function(e){"."!=e[0]&&(e="."+e)
var s=t(e).text()
return s.length<1&&this.reportError("Couldn't find the post title with class: "+e),s},e.prototype.getCurrentPostTags=function(e){"."!=e[0]&&(e="."+e)
var s=[]
return t(e+" a").each(function(){s.push(t(this).text())}),s.length<1&&this.reportError("Couldn't find any tags in this post"),s},e.prototype.getPosts=function(e){var s=[],r=[]
e.forEach(function(e){r=t.merge(r,t(e).find("item"))})
for(var n=0;n<r.length;n++){var i=t(r[n])
i.find("title").text()!==this.getCurrentPostTitle(this.options.titleClass)&&s.push({title:i.find("title").text(),url:i.find("link").text(),content:i.find("description").text(),tags:t.map(i.find("category"),function(e){return t(e).text()})})}return s.length<1&&this.reportError("Couldn't find any posts in feed: "+feed),s},e.prototype.matchByTag=function(t,e){var s=[]
return e.forEach(function(e){var r=!1
e.tags.forEach(function(n){t.forEach(function(t){t.toLowerCase()!==n.toLowerCase()||r||(s.push(e),r=!0)})})}),s.length<1&&this.reportError("There are no closely related posts"),s},e.prototype.reportError=function(e){this.options.debug&&t(this.element).append(t("<li>"+e+"</li>"))},t.fn.ghostRelated=function(t){return this.each(function(){new e(this,t)})}}(jQuery)
